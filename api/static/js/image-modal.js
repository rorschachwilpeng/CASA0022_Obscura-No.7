/**
 * Obscura No.7 - Image Modal JavaScript
 * Ëí∏Ê±ΩÊúãÂÖãÈ£éÊ†ºÁöÑÂõæÁâáÊ®°ÊÄÅÊ°Ü‰∫§‰∫íÈÄªËæë
 */

class ImageModal {
    constructor() {
        this.modal = null;
        this.currentImageData = null;
        this.isVisible = false;
        this.keydownHandler = null;
        
        this.init();
    }

    /**
     * ÂàùÂßãÂåñÊ®°ÊÄÅÊ°Ü
     */
    init() {
        this.createModalHTML();
        this.bindEvents();
        console.log('üî≠ Image Modal initialized');
    }

    /**
     * ÂàõÂª∫Ê®°ÊÄÅÊ°ÜHTMLÁªìÊûÑ
     */
    createModalHTML() {
        const modalHTML = `
            <div id="image-modal" class="image-modal" style="display: none;" aria-hidden="true" role="dialog" aria-labelledby="modal-title">
                <!-- Ê®°ÊÄÅÊ°ÜËÉåÊôØÈÅÆÁΩ© -->
                <div class="modal-backdrop" aria-hidden="true"></div>
                
                <!-- ‰∏ªÂÆπÂô® -->
                <div class="modal-container" role="document">
                    <!-- ÂÖ≥Èó≠ÊåâÈíÆ -->
                    <button class="modal-close-btn" aria-label="Close modal" title="Close (ESC)">
                        <span aria-hidden="true">‚úï</span>
                    </button>
                    
                    <!-- Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò -->
                    <h1 class="modal-main-title">üî≠ Environmental Vision Analysis</h1>
                    
                    <!-- ‰∏äÂçäÈÉ®ÂàÜÔºöÂõæÁâáÂ±ïÁ§∫Âå∫ -->
                    <div class="image-section">
                        <div class="telescope-viewer">
                            <!-- Ë£ÖÈ•∞ÊÄßÈΩøËΩÆ -->
                            <div class="gear-decoration gear-top-left" aria-hidden="true">‚öôÔ∏è</div>
                            <div class="gear-decoration gear-top-right" aria-hidden="true">‚öôÔ∏è</div>
                            <div class="gear-decoration gear-bottom-left" aria-hidden="true">‚öôÔ∏è</div>
                            <div class="gear-decoration gear-bottom-right" aria-hidden="true">‚öôÔ∏è</div>
                            
                            <!-- ÂúÜÂΩ¢ÂõæÁâáÂÆπÂô® -->
                            <div class="image-frame">
                                <img id="modal-image" src="" alt="" class="vision-image" />
                                <div class="image-loading" style="display: none;">
                                    <div class="brass-spinner">
                                        <div class="gear-spinner" aria-hidden="true">‚öôÔ∏è</div>
                                    </div>
                                    <p>Loading vision...</p>
                                </div>
                            </div>
                            
                            <!-- ÂõæÁâáÊ†áÈ¢ò -->
                            <h2 id="modal-title" class="vision-title">Vision Details</h2>
                        </div>
                    </div>
                    
                    <!-- ‰∏ãÂçäÈÉ®ÂàÜÔºö‰ø°ÊÅØÈù¢Êùø -->
                    <div class="info-section">
                        <div class="info-panel-container">
                            <h3 class="section-title">üìä Prediction Data & Analysis</h3>
                            
                            <!-- Ê†∏ÂøÉÈ¢ÑÊµãÊï∞ÊçÆ -->
                            <div class="prediction-grid">
                                <div class="data-group">
                                    <h4 class="group-title">üå°Ô∏è Environmental Conditions</h4>
                                    <div class="data-items">
                                        <div class="data-item">
                                            <span class="data-icon">üå°Ô∏è</span>
                                            <span class="data-label">Temperature:</span>
                                            <span id="summary-temperature" class="data-value">--¬∞C</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-icon">üíß</span>
                                            <span class="data-label">Humidity:</span>
                                            <span id="summary-humidity" class="data-value">--%</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-icon">üìç</span>
                                            <span class="data-label">Location:</span>
                                            <span id="summary-location" class="data-value">--</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-icon">üîÆ</span>
                                            <span class="data-label">Confidence:</span>
                                            <span id="summary-confidence" class="data-value">--%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="data-group">
                                    <h4 class="group-title">ü§ñ Generation Info</h4>
                                    <div class="data-items">
                                        <div class="data-item">
                                            <span class="data-icon">üìÖ</span>
                                            <span class="data-label">Generated:</span>
                                            <span id="summary-time" class="data-value">--</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-icon">üß†</span>
                                            <span class="data-label">AI Model:</span>
                                            <span id="summary-model" class="data-value">DALL-E 3</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-icon">üî¢</span>
                                            <span class="data-label">Prediction ID:</span>
                                            <span id="prediction-id" class="data-value">--</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-icon">‚è±Ô∏è</span>
                                            <span class="data-label">Process Time:</span>
                                            <span id="processing-time" class="data-value">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ÊèèËø∞ÈÉ®ÂàÜ -->
                            <div class="description-group">
                                <h4 class="group-title">üìù Vision Description</h4>
                                <p id="image-description" class="vision-description">Loading description...</p>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="action-group">
                                <h4 class="group-title">üîß Available Actions</h4>
                                <div class="action-buttons">
                                    <button id="view-details-btn" class="action-button primary">
                                        <span class="button-icon">üîç</span>
                                        <div class="button-content">
                                            <span class="button-label">Detailed Analysis</span>
                                            <span class="button-subtitle">View comprehensive analysis</span>
                                        </div>
                                    </button>
                                    <button id="download-btn" class="action-button secondary">
                                        <span class="button-icon">‚¨áÔ∏è</span>
                                        <div class="button-content">
                                            <span class="button-label">Download Vision</span>
                                            <span class="button-subtitle">Save to your device</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂØºËà™ÊåâÈíÆ -->
                    <button class="modal-nav modal-prev" aria-label="Previous image" title="Previous image (‚Üê)">
                        <span aria-hidden="true">‚Äπ</span>
                    </button>
                    <button class="modal-nav modal-next" aria-label="Next image" title="Next image (‚Üí)">
                        <span aria-hidden="true">‚Ä∫</span>
                    </button>
                </div>
                
                <!-- Âä†ËΩΩÁä∂ÊÄÅÊåáÁ§∫Âô® -->
                <div class="modal-loading" style="display: none;">
                    <div class="loading-content">
                        <div class="brass-spinner">
                            <div class="gear-spinner" aria-hidden="true">‚öôÔ∏è</div>
                        </div>
                        <p>Accessing temporal archive...</p>
                    </div>
                </div>
            </div>
        `;
        
        // ÊèíÂÖ•Âà∞È°µÈù¢
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.modal = document.getElementById('image-modal');
        
        // Ê∑ªÂä†TabÊ†∑Âºè
        this.addTabStyles();
    }

    /**
     * ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
     */
    bindEvents() {
        if (!this.modal) return;

        // ÂÖ≥Èó≠ÊåâÈíÆ
        const closeBtn = this.modal.querySelector('.modal-close-btn');
        closeBtn?.addEventListener('click', () => this.hide());

        // ËÉåÊôØÁÇπÂáªÂÖ≥Èó≠
        const backdrop = this.modal.querySelector('.modal-backdrop');
        backdrop?.addEventListener('click', () => this.hide());

        // ÂØºËà™ÊåâÈíÆ
        const prevBtn = this.modal.querySelector('.modal-prev');
        const nextBtn = this.modal.querySelector('.modal-next');
        prevBtn?.addEventListener('click', () => this.navigatePrevious());
        nextBtn?.addEventListener('click', () => this.navigateNext());

        // ËØ¶ÁªÜÂàÜÊûêÊåâÈíÆ
        const detailBtn = this.modal.querySelector('#view-details-btn');
        detailBtn?.addEventListener('click', () => this.openDetailPage());

        // ‰∏ãËΩΩÊåâÈíÆ
        const downloadBtn = this.modal.querySelector('#download-btn');
        downloadBtn?.addEventListener('click', () => this.downloadImage());



        // ÈîÆÁõòÂØºËà™
        this.keydownHandler = (e) => this.handleKeydown(e);
    }

    /**
     * ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
     * @param {Object} imageData - ÂõæÁâáÊï∞ÊçÆ
     * @param {Array} galleryImages - ÁîªÂªä‰∏≠ÊâÄÊúâÂõæÁâáÔºàÁî®‰∫éÂØºËà™Ôºâ
     * @param {number} currentIndex - ÂΩìÂâçÂõæÁâáÁ¥¢Âºï
     */
    async show(imageData, galleryImages = [], currentIndex = 0) {
        if (!this.modal || !imageData) return;

        this.currentImageData = imageData;
        this.galleryImages = galleryImages;
        this.currentIndex = currentIndex;

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        this.showLoading();
        
        // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
        this.modal.style.display = 'flex';
        this.modal.setAttribute('aria-hidden', 'false');
        this.isVisible = true;

        // Ê∑ªÂä†ÈîÆÁõòÁõëÂê¨
        document.addEventListener('keydown', this.keydownHandler);
        
        // Á¶ÅÁî®È°µÈù¢ÊªöÂä®
        document.body.style.overflow = 'hidden';

        // Ëé∑ÂèñÂÆåÊï¥ÂõæÁâáÊï∞ÊçÆ
        try {
            const fullData = await this.fetchImageData(imageData.id);
            await this.populateModal(fullData);
            this.hideLoading();
            
            // Âä®ÁîªÊïàÊûú
            requestAnimationFrame(() => {
                this.modal.classList.add('modal-visible');
            });
            
        } catch (error) {
            console.error('Error loading image data:', error);
            console.warn('Using basic image data as fallback');
            
            // Fallback: ‰ΩøÁî®Âü∫Á°ÄÂõæÁâáÊï∞ÊçÆÂ°´ÂÖÖÊ®°ÊÄÅÊ°Ü
            await this.populateModal({ image: imageData });
            this.hideLoading();
            
            // Âä®ÁîªÊïàÊûú
            requestAnimationFrame(() => {
                this.modal.classList.add('modal-visible');
            });
        }
    }

    /**
     * ÈöêËóèÊ®°ÊÄÅÊ°Ü
     */
    hide() {
        if (!this.modal || !this.isVisible) return;

        // ÁßªÈô§Âä®ÁîªÁ±ª
        this.modal.classList.remove('modal-visible');
        
        // Âª∂ËøüÈöêËóè‰ª•ÂÆåÊàêÂä®Áîª
        setTimeout(() => {
            this.modal.style.display = 'none';
            this.modal.setAttribute('aria-hidden', 'true');
            this.isVisible = false;
            
            // ÁßªÈô§ÈîÆÁõòÁõëÂê¨
            document.removeEventListener('keydown', this.keydownHandler);
            
            // ÊÅ¢Â§çÈ°µÈù¢ÊªöÂä®
            document.body.style.overflow = '';
            
            // Ê∏ÖÁêÜÊï∞ÊçÆ
            this.currentImageData = null;
            this.galleryImages = [];
            this.currentIndex = 0;
        }, 300);
    }

    /**
     * Ëé∑ÂèñÂõæÁâáËØ¶ÁªÜÊï∞ÊçÆ
     * @param {number} imageId - ÂõæÁâáID
     */
    async fetchImageData(imageId) {
        const response = await fetch(`/api/v1/images/${imageId}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return await response.json();
    }

    /**
     * Â°´ÂÖÖÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπ
     * @param {Object} data - ÂõæÁâáÂÆåÊï¥Êï∞ÊçÆ
     */
    async populateModal(data) {
        console.log('Populating modal with data:', data);
        
        // Â§ÑÁêÜ‰∏çÂêåÁöÑÊï∞ÊçÆÁªìÊûÑ
        const image = data.image || data;
        const prediction = data.prediction || {};

        // ËÆæÁΩÆÂõæÁâá
        const modalImage = this.modal.querySelector('#modal-image');
        if (modalImage && image.url) {
            modalImage.src = image.url;
            modalImage.alt = image.description || 'AI Generated Environmental Vision';
            
            // ÂõæÁâáÂä†ËΩΩÂ§ÑÁêÜ
            try {
                await new Promise((resolve, reject) => {
                    modalImage.onload = resolve;
                    modalImage.onerror = reject;
                    // ËÆæÁΩÆË∂ÖÊó∂
                    setTimeout(reject, 10000);
                });
            } catch (error) {
                console.warn('Image loading timeout or error:', error);
            }
        }

        // Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
        const titleElement = this.modal.querySelector('#modal-title');
        if (titleElement) {
            titleElement.textContent = image.description || 'Environmental Vision';
        }
        
        // Â°´ÂÖÖÈ¢ÑÊµãÊï∞ÊçÆÔºà‰ªépredictionÊàñinput_data‰∏≠ÊèêÂèñÔºâ
        const resultData = prediction.result_data || {};
        const inputData = prediction.input_data || {};
        
        // Ê∏©Â∫¶‰ø°ÊÅØ
        const tempElement = this.modal.querySelector('#summary-temperature');
        if (tempElement) {
            const temp = resultData.temperature || inputData.temperature || prediction.temperature;
            tempElement.textContent = temp ? `${Math.round(temp)}¬∞C` : '--¬∞C';
        }
        
        // ÊπøÂ∫¶‰ø°ÊÅØ
        const humidityElement = this.modal.querySelector('#summary-humidity');
        if (humidityElement) {
            const humidity = resultData.humidity || inputData.humidity || prediction.humidity;
            humidityElement.textContent = humidity ? `${Math.round(humidity)}%` : '--%';
        }
        
        // ‰ΩçÁΩÆ‰ø°ÊÅØ
        const locationElement = this.modal.querySelector('#summary-location');
        if (locationElement) {
            const location = prediction.location || inputData.location || 'Global';
            locationElement.textContent = location;
        }
        
        // ÁΩÆ‰ø°Â∫¶‰ø°ÊÅØ
        const confidenceElement = this.modal.querySelector('#summary-confidence');
        if (confidenceElement) {
            const confidence = resultData.confidence || prediction.confidence || 0.85;
            confidenceElement.textContent = `${Math.round(confidence * 100)}%`;
        }
        
        // Êó∂Èó¥‰ø°ÊÅØ
        const timeElement = this.modal.querySelector('#summary-time');
        if (timeElement) {
            const date = new Date(image.created_at);
            timeElement.textContent = date.toLocaleString();
        }
        
        // ÊèèËø∞‰ø°ÊÅØ
        const descElement = this.modal.querySelector('#image-description');
        if (descElement) {
            descElement.textContent = image.description || 
                'A glimpse into a possible environmental future, generated by AI based on predictive environmental data.';
        }

        // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
        this.updateNavigationButtons();
        
        // ËÆæÁΩÆËØ¶ÁªÜÂàÜÊûêÊåâÈíÆ
        const detailBtn = this.modal.querySelector('#view-details-btn');
        if (detailBtn) {
            detailBtn.dataset.imageId = image.id;
        }
        
        // Â°´ÂÖÖÊäÄÊúØ‰ø°ÊÅØ
        const predictionIdElement = this.modal.querySelector('#prediction-id');
        if (predictionIdElement) {
            predictionIdElement.textContent = image.prediction_id || '--';
        }
        
        const processingTimeElement = this.modal.querySelector('#processing-time');
        if (processingTimeElement) {
            // ÁÆÄÂçïÁöÑÂ§ÑÁêÜÊó∂Èó¥‰º∞ÁÆó
            processingTimeElement.textContent = '~2-3 minutes';
        }
    }

    /**
     * Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
     */
    updateNavigationButtons() {
        const prevBtn = this.modal.querySelector('.modal-prev');
        const nextBtn = this.modal.querySelector('.modal-next');
        
        if (this.galleryImages.length <= 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
            nextBtn.style.display = 'block';
            
            prevBtn.disabled = this.currentIndex === 0;
            nextBtn.disabled = this.currentIndex === this.galleryImages.length - 1;
        }
    }

    /**
     * ÂØºËà™Âà∞‰∏ä‰∏ÄÂº†ÂõæÁâá
     */
    async navigatePrevious() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            const imageData = this.galleryImages[this.currentIndex];
            await this.show(imageData, this.galleryImages, this.currentIndex);
        }
    }

    /**
     * ÂØºËà™Âà∞‰∏ã‰∏ÄÂº†ÂõæÁâá
     */
    async navigateNext() {
        if (this.currentIndex < this.galleryImages.length - 1) {
            this.currentIndex++;
            const imageData = this.galleryImages[this.currentIndex];
            await this.show(imageData, this.galleryImages, this.currentIndex);
        }
    }

    /**
     * ÊâìÂºÄËØ¶ÁªÜÂàÜÊûêÈ°µÈù¢
     */
    openDetailPage() {
        if (this.currentImageData) {
            const imageId = this.currentImageData.id;
            window.location.href = `/image/${imageId}`;
        }
    }

    /**
     * ‰∏ãËΩΩÂõæÁâá
     */
    async downloadImage() {
        if (!this.currentImageData) return;

        try {
            const image = this.modal.querySelector('#modal-image');
            const link = document.createElement('a');
            link.href = image.src;
            link.download = `obscura-vision-${this.currentImageData.id}.jpg`;
            link.target = '_blank';
            link.click();
        } catch (error) {
            console.error('Download failed:', error);
        }
    }

    /**
     * Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
     * @param {KeyboardEvent} e - ÈîÆÁõò‰∫ã‰ª∂
     */
    handleKeydown(e) {
        if (!this.isVisible) return;

        switch (e.key) {
            case 'Escape':
                e.preventDefault();
                this.hide();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                this.navigatePrevious();
                break;
            case 'ArrowRight':
                e.preventDefault();
                this.navigateNext();
                break;
            case 'Enter':
                if (e.target.classList.contains('detail-button')) {
                    e.preventDefault();
                    this.openDetailPage();
                }
                break;
        }
    }

    /**
     * ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
     */
    showLoading() {
        const loading = this.modal.querySelector('.modal-loading');
        if (loading) {
            loading.style.display = 'flex';
        }
    }

    /**
     * ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
     */
    hideLoading() {
        const loading = this.modal.querySelector('.modal-loading');
        if (loading) {
            loading.style.display = 'none';
        }
    }

    /**
     * ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
     * @param {string} message - ÈîôËØØ‰ø°ÊÅØ
     */
    showError(message) {
        console.error('Modal error:', message);
        
        // ÊòæÁ§∫ÈîôËØØÈÄöÁü•
        if (window.showNotification) {
            window.showNotification(message, 'error');
        }
        
        // ÈöêËóèÊ®°ÊÄÅÊ°Ü
        this.hide();
    }

    /**
     * Ê∑ªÂä†Ê®°ÊÄÅÊ°ÜÊ†∑Âºè
     */
    addTabStyles() {
        const modalStyles = `
            <style id="modal-tab-styles">
                /* CSSÂèòÈáèÂÆö‰πâ */
                :root {
                    --brass: #B8860B;
                    --brass-gradient: linear-gradient(45deg, #B8860B, #DAA520);
                    --brass-dark: #8B7D3A;
                    --copper: #B87333;
                    --copper-gradient: linear-gradient(45deg, #B87333, #CD7F32);
                    --copper-light: #D2B48C;
                    --amber: #FFB347;
                    --coal: #2c2c2c;
                }
                
                /* Ê®°ÊÄÅÊ°ÜÂü∫Á°ÄÊ†∑Âºè */
                .image-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .modal-backdrop {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(5px);
                }
                
                .modal-container {
                    position: relative;
                    width: 90vw;
                    max-width: 1200px;
                    height: 90vh;
                    display: flex;
                    flex-direction: column;
                    background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
                    border-radius: 20px;
                    overflow: hidden;
                    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                }
                
                /* ÂÖ≥Èó≠ÊåâÈíÆ */
                .modal-close-btn {
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    background: var(--brass-gradient);
                    border: 3px solid var(--brass-dark);
                    color: var(--coal);
                    font-size: 1.8rem;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    z-index: 100;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .modal-close-btn:hover {
                    background: var(--copper-gradient);
                    transform: scale(1.1) rotate(90deg);
                    box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
                }
                
                /* ‰∏ªÊ†áÈ¢ò */
                .modal-main-title {
                    text-align: center;
                    color: var(--amber);
                    font-size: 2rem;
                    font-weight: bold;
                    margin: 20px 0;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                    letter-spacing: 1px;
                }
                
                /* ‰∏äÂçäÈÉ®ÂàÜÔºöÂõæÁâáÂ±ïÁ§∫Âå∫ */
                .image-section {
                    flex: 0 0 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: radial-gradient(circle, #3a3a3a, #2c2c2c);
                    position: relative;
                    padding: 20px;
                }
                
                .telescope-viewer {
                    position: relative;
                    width: 400px;
                    height: 400px;
                }
                
                /* Ë£ÖÈ•∞ÈΩøËΩÆ */
                .gear-decoration {
                    position: absolute;
                    font-size: 2rem;
                    color: var(--brass);
                    animation: rotate 20s linear infinite;
                    opacity: 0.6;
                }
                
                .gear-top-left { top: -10px; left: -10px; }
                .gear-top-right { top: -10px; right: -10px; animation-direction: reverse; }
                .gear-bottom-left { bottom: -10px; left: -10px; animation-direction: reverse; }
                .gear-bottom-right { bottom: -10px; right: -10px; }
                
                @keyframes rotate {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                
                /* ÂúÜÂΩ¢ÂõæÁâáÊ°Ü */
                .image-frame {
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    border: 8px solid var(--brass);
                    overflow: hidden;
                    box-shadow: 
                        0 0 30px rgba(255, 179, 71, 0.3),
                        inset 0 0 20px rgba(0, 0, 0, 0.3);
                    position: relative;
                }
                
                .vision-image {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    border-radius: 50%;
                }
                
                .vision-title {
                    position: absolute;
                    bottom: -50px;
                    left: 50%;
                    transform: translateX(-50%);
                    color: var(--amber);
                    font-size: 1.5rem;
                    font-weight: bold;
                    text-align: center;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
                    margin: 0;
                }
                
                /* ‰∏ãÂçäÈÉ®ÂàÜÔºö‰ø°ÊÅØÈù¢Êùø */
                .info-section {
                    flex: 0 0 50%;
                    background: linear-gradient(135deg, var(--brass), var(--copper));
                    padding: 30px;
                    overflow-y: auto;
                }
                
                .info-panel-container {
                    background: rgba(44, 44, 44, 0.9);
                    border-radius: 15px;
                    padding: 25px;
                    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
                }
                
                .section-title {
                    color: var(--amber);
                    font-size: 1.5rem;
                    font-weight: bold;
                    margin-bottom: 20px;
                    text-align: center;
                    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
                }
                
                /* È¢ÑÊµãÊï∞ÊçÆÁΩëÊ†º */
                .prediction-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 25px;
                }
                
                .data-group {
                    background: rgba(255, 179, 71, 0.1);
                    border-radius: 10px;
                    padding: 15px;
                    border: 2px solid var(--brass-dark);
                }
                
                .group-title {
                    color: var(--amber);
                    font-size: 1.1rem;
                    font-weight: bold;
                    margin-bottom: 10px;
                    text-align: center;
                }
                
                .data-items {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .data-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 5px;
                    background: rgba(0, 0, 0, 0.2);
                    border-radius: 5px;
                }
                
                .data-icon {
                    font-size: 1.2rem;
                }
                
                .data-label {
                    color: var(--copper-light);
                    font-weight: bold;
                    flex: 1;
                }
                
                .data-value {
                    color: var(--amber);
                    font-weight: bold;
                }
                
                /* ÊèèËø∞ÁªÑ */
                .description-group {
                    background: rgba(255, 179, 71, 0.1);
                    border-radius: 10px;
                    padding: 15px;
                    border: 2px solid var(--brass-dark);
                    margin-bottom: 20px;
                }
                
                .vision-description {
                    color: var(--copper-light);
                    line-height: 1.6;
                    margin: 10px 0 0 0;
                    font-style: italic;
                }
                
                /* Êìç‰ΩúÊåâÈíÆÁªÑ */
                .action-group {
                    background: rgba(255, 179, 71, 0.1);
                    border-radius: 10px;
                    padding: 15px;
                    border: 2px solid var(--brass-dark);
                }
                
                .action-buttons {
                    display: flex;
                    gap: 15px;
                    justify-content: center;
                }
                
                .action-button {
                    flex: 1;
                    padding: 15px;
                    border-radius: 10px;
                    border: 2px solid var(--brass-dark);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-weight: bold;
                }
                
                .action-button.primary {
                    background: var(--brass-gradient);
                    color: var(--coal);
                }
                
                .action-button.secondary {
                    background: var(--copper-gradient);
                    color: var(--coal);
                }
                
                .action-button:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                }
                
                .button-icon {
                    font-size: 1.5rem;
                }
                
                .button-content {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                }
                
                .button-label {
                    font-size: 1rem;
                    font-weight: bold;
                }
                
                .button-subtitle {
                    font-size: 0.8rem;
                    opacity: 0.8;
                    font-weight: normal;
                }
                
                /* ÂØºËà™ÊåâÈíÆ */
                .modal-nav {
                    position: absolute;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: var(--brass-gradient);
                    border: 3px solid var(--brass-dark);
                    color: var(--coal);
                    font-size: 2rem;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    z-index: 50;
                }
                
                .modal-prev { left: 20px; }
                .modal-next { right: 20px; }
                
                .modal-nav:hover {
                    background: var(--copper-gradient);
                    transform: translateY(-50%) scale(1.1);
                }
                
                .modal-nav:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                /* ÂìçÂ∫îÂºèËÆæËÆ° */
                @media (max-width: 768px) {
                    .modal-container {
                        width: 95vw;
                        height: 95vh;
                    }
                    
                    .prediction-grid {
                        grid-template-columns: 1fr;
                    }
                    
                    .action-buttons {
                        flex-direction: column;
                    }
                    
                    .telescope-viewer {
                        width: 300px;
                        height: 300px;
                    }
                }
            </style>
        `;
        
        // ÁßªÈô§ÊóßÊ†∑Âºè
        const existingStyles = document.getElementById('modal-tab-styles');
        if (existingStyles) {
            existingStyles.remove();
        }
        
        // Ê∑ªÂä†Êñ∞Ê†∑Âºè
        document.head.insertAdjacentHTML('beforeend', modalStyles);
    }
}

// ÂÖ®Â±ÄÂÆû‰æãÂíåÁ±ª
window.ImageModal = ImageModal;
window.imageModal = null;

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    window.imageModal = new ImageModal();
    
    // ‰∏∫‰∫ÜÂêëÂêéÂÖºÂÆπÔºå‰πüËÆæÁΩÆ‰∏∫ImageModal
    window.ImageModal.instance = window.imageModal;
    window.ImageModal.show = (imageData, galleryImages, currentIndex) => {
        return window.imageModal.show(imageData, galleryImages, currentIndex);
    };
});

// ÂØºÂá∫Á±ªÔºàÂ¶ÇÊûú‰ΩøÁî®Ê®°ÂùóÁ≥ªÁªüÔºâ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ImageModal;
}
