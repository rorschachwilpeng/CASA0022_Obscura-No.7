/**
 * ÂúÜÂΩ¢ÊâìÂåÖÂõæÂèØËßÜÂåñÁªÑ‰ª∂
 * Âü∫‰∫éD3.jsÂíåEChartsÂÆûÁé∞SHAPÁâπÂæÅÈáçË¶ÅÊÄßÁöÑÂ±ÇÊ¨°ÂåñÂèØËßÜÂåñ
 */

class PackChart {
    constructor(containerId, options = {}) {
        this.containerId = containerId;
        this.container = document.getElementById(containerId);
        this.options = {
            width: options.width || 800,
            height: options.height || 600,
            padding: options.padding || 20,
            colors: {
                climate: '#FF6B6B',    // Á∫¢Ëâ≤ - Ê∞îÂÄô
                geographic: '#4ECDC4', // ÈùíËâ≤ - Âú∞ÁêÜ  
                economic: '#45B7D1',   // ËìùËâ≤ - ÁªèÊµé
                root: '#FFA726',       // Ê©ôËâ≤ - Ê†πËäÇÁÇπ
                positive: '#4CAF50',   // ÁªøËâ≤ - Ê≠£ÂêëÂΩ±Âìç
                negative: '#F44336'    // Á∫¢Ëâ≤ - Ë¥üÂêëÂΩ±Âìç
            },
            steampunkColors: {
                brass: '#B8860B',      // ÈªÑÈìúËâ≤
                copper: '#CD7F32',     // ÈìúËâ≤  
                bronze: '#8C6239',     // ÈùíÈìúËâ≤
                steam: '#708090',      // Ëí∏Ê±ΩÁÅ∞
                gear: '#2F4F4F'        // ÈΩøËΩÆËâ≤
            },
            ...options
        };
        
        this.chart = null;
        this.currentData = null;
        this.currentFocus = 'overview';
        
        this.initChart();
    }

    /**
     * ÂàùÂßãÂåñEChartsÂÆû‰æã
     */
    initChart() {
        if (!this.container) {
            console.error(`Container ${this.containerId} not found`);
            return;
        }

        // ÂàùÂßãÂåñECharts
        this.chart = echarts.init(this.container);
        
        // ËÆæÁΩÆÂìçÂ∫îÂºè
        window.addEventListener('resize', () => {
            this.chart.resize();
        });

        console.log('‚úÖ Pack chart initialized');
    }

    /**
     * Ê∏≤ÊüìÂúÜÂΩ¢ÊâìÂåÖÂõæ
     */
    render(data) {
        if (!this.chart || !data) {
            console.error('Chart or data not available');
            return;
        }

        this.currentData = data;
        
        // Â§ÑÁêÜÊï∞ÊçÆ‰∏∫EChartsÊ†ºÂºè
        const chartData = this.processData(data);
        
        // ÈÖçÁΩÆEChartsÈÄâÈ°π
        const option = this.buildChartOption(chartData);
        
        // Ê∏≤ÊüìÂõæË°®
        this.chart.setOption(option);
        
        // ÁªëÂÆö‰∫§‰∫í‰∫ã‰ª∂
        this.bindEvents();
        
        console.log('‚úÖ Pack chart rendered successfully');
    }

    /**
     * Â§ÑÁêÜÊï∞ÊçÆ‰∏∫EChartsÂ±ÇÊ¨°ÁªìÊûÑ
     */
    processData(rawData) {
        const processNode = (node, depth = 0) => {
            const processed = {
                name: node.name,
                value: node.value * 1000, // ÊîæÂ§ß‰ª•‰æøÊòæÁ§∫
                depth: depth,
                originalValue: node.value,
                impact: node.impact || node.value,
                itemStyle: {
                    color: this.getNodeColor(node, depth)
                }
            };

            if (node.children && node.children.length > 0) {
                processed.children = node.children.map(child => 
                    processNode(child, depth + 1)
                );
            }

            return processed;
        };

        return processNode(rawData);
    }

    /**
     * Ëé∑ÂèñËäÇÁÇπÈ¢úËâ≤
     */
    getNodeColor(node, depth) {
        // Ê†πËäÇÁÇπ
        if (depth === 0) {
            return this.options.steampunkColors.brass;
        }
        
        // Áª¥Â∫¶ËäÇÁÇπ
        if (depth === 1) {
            switch (node.name.toLowerCase()) {
                case 'climate':
                    return this.options.colors.climate;
                case 'geographic':
                    return this.options.colors.geographic;
                case 'economic':
                    return this.options.colors.economic;
                default:
                    return this.options.steampunkColors.copper;
            }
        }
        
        // ÁâπÂæÅËäÇÁÇπ - Ê†πÊçÆÂΩ±ÂìçÊñπÂêëÁùÄËâ≤
        if (depth === 2) {
            const impact = node.impact || 0;
            if (impact > 0) {
                return this.options.colors.positive;
            } else if (impact < 0) {
                return this.options.colors.negative;
            } else {
                return this.options.steampunkColors.steam;
            }
        }
        
        return this.options.steampunkColors.gear;
    }

    /**
     * ÊûÑÂª∫EChartsÈÖçÁΩÆÈÄâÈ°π
     */
    buildChartOption(data) {
        return {
            title: {
                text: 'Environmental Feature Impact',
                left: 'center',
                top: 20,
                textStyle: {
                    color: this.options.steampunkColors.brass,
                    fontSize: 18,
                    fontWeight: 'bold'
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: (params) => {
                    const data = params.data;
                    const impact = data.impact || data.originalValue || 0;
                    const impactText = impact > 0 ? 'Positive' : impact < 0 ? 'Negative' : 'Neutral';
                    
                    return `
                        <div style="padding: 10px;">
                            <strong>${data.name}</strong><br/>
                            Impact: ${(impact * 100).toFixed(1)}%<br/>
                            Influence: ${impactText}<br/>
                            Depth Level: ${data.depth}
                        </div>
                    `;
                },
                backgroundColor: 'rgba(0,0,0,0.8)',
                borderColor: this.options.steampunkColors.brass,
                borderWidth: 1,
                textStyle: {
                    color: '#fff'
                }
            },
            series: [{
                type: 'sunburst',
                data: [data],
                radius: [0, '90%'],
                center: ['50%', '55%'],
                sort: null,
                emphasis: {
                    focus: 'ancestor'
                },
                label: {
                    fontSize: 12,
                    fontWeight: 'bold',
                    color: '#fff',
                    textShadowColor: 'rgba(0, 0, 0, 0.5)',
                    textShadowBlur: 2
                },
                levels: [
                    {},
                    {
                        r0: '15%',
                        r: '35%',
                        itemStyle: {
                            borderWidth: 2,
                            borderColor: this.options.steampunkColors.bronze
                        },
                        label: {
                            fontSize: 14,
                            fontWeight: 'bold'
                        }
                    },
                    {
                        r0: '35%',
                        r: '70%',
                        itemStyle: {
                            borderWidth: 1,
                            borderColor: '#fff'
                        },
                        label: {
                            fontSize: 10
                        }
                    },
                    {
                        r0: '70%',
                        r: '90%',
                        label: {
                            position: 'outside',
                            fontSize: 8,
                            silent: false
                        },
                        itemStyle: {
                            borderWidth: 1
                        }
                    }
                ]
            }]
        };
    }

    /**
     * ÁªëÂÆö‰∫§‰∫í‰∫ã‰ª∂
     */
    bindEvents() {
        // ÁÇπÂáª‰∫ã‰ª∂ - ÈíªÂèñ
        this.chart.off('click');
        this.chart.on('click', (params) => {
            if (params.data.children) {
                console.log(`üéØ Drilling down into: ${params.data.name}`);
                // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÈíªÂèñÈÄªËæë
                this.focusDimension(params.data.name.toLowerCase());
            }
        });

        // Èº†Ê†áÊÇ¨ÂÅú‰∫ã‰ª∂
        this.chart.off('mouseover');
        this.chart.on('mouseover', (params) => {
            // È´ò‰∫ÆÊïàÊûúÂ∑≤Áî±EChartsÂÜÖÁΩÆÂ§ÑÁêÜ
        });
    }

    /**
     * ËÅöÁÑ¶ÁâπÂÆöÁª¥Â∫¶
     */
    focusDimension(dimension) {
        if (!this.currentData) return;

        this.currentFocus = dimension;
        
        console.log(`üéØ Focusing on dimension: ${dimension}`);
        
        // Ê†πÊçÆÁª¥Â∫¶Ë∞ÉÊï¥Êï∞ÊçÆËßÜÂõæ
        let focusedData;
        
        if (dimension === 'overview') {
            focusedData = this.currentData;
        } else {
            // ÊâæÂà∞ÁâπÂÆöÁª¥Â∫¶ÁöÑÊï∞ÊçÆ
            const dimensionData = this.currentData.children?.find(
                child => child.name.toLowerCase() === dimension
            );
            
            if (dimensionData) {
                focusedData = {
                    name: dimensionData.name + ' Analysis',
                    value: dimensionData.value,
                    children: dimensionData.children || []
                };
            } else {
                focusedData = this.currentData;
            }
        }
        
        // ÈáçÊñ∞Ê∏≤Êüì
        const chartData = this.processData(focusedData);
        const option = this.buildChartOption(chartData);
        
        this.chart.setOption(option, true);
        
        // Êõ¥Êñ∞UIÊåâÈíÆÁä∂ÊÄÅ
        this.updateControlButtons(dimension);
    }

    /**
     * Êõ¥Êñ∞ÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅ
     */
    updateControlButtons(activeDimension) {
        const buttons = document.querySelectorAll('.viz-control-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-dimension') === activeDimension) {
                btn.classList.add('active');
            }
        });
    }

    /**
     * Êõ¥Êñ∞Êï∞ÊçÆ
     */
    updateData(newData) {
        this.render(newData);
    }

    /**
     * ÈîÄÊØÅÂõæË°®
     */
    dispose() {
        if (this.chart) {
            this.chart.dispose();
            this.chart = null;
        }
    }

    /**
     * Ëé∑ÂèñÂΩìÂâçÂõæË°®Áä∂ÊÄÅ
     */
    getState() {
        return {
            focus: this.currentFocus,
            data: this.currentData
        };
    }
}

// Â∞ÜÁ±ªÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
window.PackChart = PackChart; 