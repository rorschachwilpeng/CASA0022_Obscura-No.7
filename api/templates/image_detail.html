<!-- Obscura No.7 - Image Detail Page Template -->

{% extends "base.html" %}

{% block title %}Image Analysis - Obscura No.7{% endblock %}

{% block og_title %}Environmental Prediction Analysis - Obscura No.7{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/image-detail.css') }}">
{% endblock %}

{% block content %}
<div class="detail-page">
    <div class="detail-container" data-image-id="{% if image_id %}{{ image_id }}{% endif %}">
        <!-- Page Header -->
        <header class="detail-header">
            <h1 class="detail-title" id="imageTitle">Environmental Vision Analysis</h1>
            <p class="detail-subtitle" id="imageSubtitle">AI-Generated Environmental Art with SHAP Interpretability</p>
            
            <!-- Breadcrumb Navigation -->
            <nav class="breadcrumb" aria-label="Breadcrumb navigation">
                <a href="{{ url_for('frontend.home') }}" aria-label="Home">ğŸ  Observatory</a>
                <span class="breadcrumb-separator" aria-hidden="true">âš™ï¸</span>
                <a href="{{ url_for('frontend.gallery') }}" aria-label="Gallery">ğŸ“¸ Gallery</a>
                <span class="breadcrumb-separator" aria-hidden="true">âš™ï¸</span>
                <span aria-current="page">ğŸ” Analysis</span>
            </nav>
        </header>

        <!-- æ¨¡å—1: å›¾ç‰‡æ˜¾ç¤º -->
        <section class="image-panel" aria-labelledby="image-section-title">
            <h2 id="image-section-title" class="sr-only">Generated Image</h2>
            
            <div class="image-display">
                <img class="main-image" 
                     id="mainImage" 
                     alt=""
                     tabindex="0"
                     role="img">
                
                <!-- Image Overlay Controls -->
                <div class="image-overlay">
                    <button class="overlay-button" 
                            id="fullscreenBtn" 
                            type="button"
                            title="Fullscreen View (Ctrl+F)"
                            aria-label="View image in fullscreen">
                        â›¶
                    </button>
                    <button class="overlay-button" 
                            id="shareBtn" 
                            type="button"
                            title="Share Image (Ctrl+S)"
                            aria-label="Share this image">
                        ğŸ“¤
                    </button>
                </div>
            </div>
            
            <!-- Image Metadata -->
            <div class="image-metadata">
                <div class="metadata-item">
                    <div class="metadata-label">Resolution</div>
                    <div class="metadata-value" id="imageResolution">Loading...</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">File Size</div>
                    <div class="metadata-value" id="imageFileSize">Loading...</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Generation Time</div>
                    <div class="metadata-value" id="imageGenTime">Loading...</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Prediction ID</div>
                    <div class="metadata-value" id="imagePredictionId">Loading...</div>
                </div>
            </div>
        </section>

        <!-- æ¨¡å—2: AIç”Ÿæˆæ•…äº‹ -->
        <section class="ai-story-section" aria-labelledby="story-section-title">
            <div class="story-header">
                <h2 class="story-title" id="story-section-title">
                    <span class="story-icon" aria-hidden="true">ğŸ“–</span>
                    Environmental Narrative
                </h2>
                <p class="story-description">
                    AI-generated environmental story based on SHAP analysis findings
                </p>
            </div>
            
            <div class="story-container">
                <div class="story-loading" id="storyLoading">
                    <div class="story-spinner" aria-hidden="true">âœï¸</div>
                    <p>Generating environmental narrative...</p>
                </div>
                <div class="story-content" id="storyContent" style="display: none;">
                    <!-- AIæ•…äº‹å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    <div class="narrative-text" id="narrativeText">
                        Loading story...
                    </div>
                </div>
            </div>
        </section>

        <!-- æ¨¡å—3: SHAPå¯è§†åŒ–åˆ†æ -->
        <section class="shap-visualization-section" aria-labelledby="shap-viz-section-title">
            <div class="shap-viz-header">
                <h2 class="shap-viz-title" id="shap-viz-section-title">
                    <span class="shap-viz-icon" aria-hidden="true">ğŸ¯</span>
                    Feature Impact Analysis
                </h2>
                <p class="shap-viz-description">
                    Interactive visualization of climate, geographic, and economic factors
                </p>
            </div>
            
            <!-- SHAPä¸‰ç»´åº¦è¯„åˆ† -->
            <div class="shap-scores-overview" id="shapScoresOverview">
                <div class="score-card climate">
                    <div class="score-header">
                        <span class="score-icon" aria-hidden="true">ğŸŒ¡ï¸</span>
                        <h3>Climate</h3>
                    </div>
                    <div class="score-value" id="climateScore">Loading...</div>
                </div>
                
                <div class="score-card geographic">
                    <div class="score-header">
                        <span class="score-icon" aria-hidden="true">ğŸ—ºï¸</span>
                        <h3>Geographic</h3>
                    </div>
                    <div class="score-value" id="geographicScore">Loading...</div>
                </div>
                
                <div class="score-card economic">
                    <div class="score-header">
                        <span class="score-icon" aria-hidden="true">ğŸ’°</span>
                        <h3>Economic</h3>
                    </div>
                    <div class="score-value" id="economicScore">Loading...</div>
                </div>
            </div>
            
            <!-- åœ†å½¢æ‰“åŒ…å›¾å¯è§†åŒ–å®¹å™¨ -->
            <div class="pack-chart-container">
                <div class="chart-loading" id="packChartLoading">
                    <div class="chart-spinner" aria-hidden="true">âš™ï¸</div>
                    <p>Loading feature impact visualization...</p>
                </div>
                <div id="packChart" class="pack-chart" style="display: none;">
                    <!-- åœ†å½¢æ‰“åŒ…å›¾å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                </div>
            </div>
            
            <!-- å¯è§†åŒ–æ§åˆ¶ -->
            <div class="viz-controls" id="vizControls" style="display: none;">
                <button class="viz-control-btn active" data-dimension="overview">
                    <span aria-hidden="true">ğŸ¯</span>
                    Overview
                </button>
                <button class="viz-control-btn" data-dimension="climate">
                    <span aria-hidden="true">ğŸŒ¡ï¸</span>
                    Climate
                </button>
                <button class="viz-control-btn" data-dimension="geographic">
                    <span aria-hidden="true">ğŸ—ºï¸</span>
                    Geographic
                </button>
                <button class="viz-control-btn" data-dimension="economic">
                    <span aria-hidden="true">ğŸ’°</span>
                    Economic
                </button>
            </div>
        </section>

        <!-- Action Bar -->
        <section class="action-bar" aria-labelledby="actions-title">
            <h2 id="actions-title" class="sr-only">Available Actions</h2>
            
            <div class="action-buttons">
                <button class="action-button" 
                        id="downloadBtn" 
                        type="button"
                        title="Download Image (Ctrl+D)">
                    <span aria-hidden="true">ğŸ’¾</span>
                    <span>Download Image</span>
                </button>
                
                <button class="action-button" 
                        id="shareImageBtn" 
                        type="button"
                        title="Share Analysis (Ctrl+S)">
                    <span aria-hidden="true">ğŸ“¤</span>
                    <span>Share Analysis</span>
                </button>
                
                <a href="{{ url_for('frontend.gallery') }}" 
                   class="action-button secondary"
                   title="Return to Gallery">
                    <span aria-hidden="true">ğŸ–¼ï¸</span>
                    <span>Back to Gallery</span>
                </a>
                
                <a href="{{ url_for('frontend.home') }}" 
                   class="action-button secondary"
                   title="Return to Home">
                    <span aria-hidden="true">ğŸ </span>
                    <span>Observatory Home</span>
                </a>
            </div>
        </section>
    </div>
</div>

<!-- Fullscreen Overlay -->
<div class="fullscreen-overlay" id="fullscreenOverlay" aria-hidden="true">
    <img class="fullscreen-image" 
         id="fullscreenImage" 
         alt=""
         role="img">
    <button class="fullscreen-close" 
            id="fullscreenClose" 
            type="button"
            aria-label="Exit fullscreen"
            title="Exit Fullscreen (ESC)">
        âœ•
    </button>
</div>

<!-- Loading Overlay for Initial Data -->
<div class="page-loading" id="pageLoading" aria-hidden="false">
    <div class="loading-content">
        <div class="brass-spinner">
            <div class="gear-spinner" aria-hidden="true">âš™ï¸</div>
        </div>
        <p>Processing through temporal mechanisms...</p>
    </div>
</div>

<!-- Screen Reader Announcements -->
<div class="sr-only" aria-live="polite" id="srAnnouncements"></div>

<!-- Hidden Elements for Screen Readers -->
<div class="sr-only">
    <h2>Page Navigation Help</h2>
    <p>This page displays detailed analysis of an AI-generated environmental prediction image. Use keyboard shortcuts: Ctrl+F for fullscreen, Ctrl+D to download, Ctrl+S to share, ESC to close overlays.</p>
</div>
{% endblock %}

{% block extra_js %}
<!-- D3.jsåº“ç”¨äºåœ†å½¢æ‰“åŒ…å›¾å¯è§†åŒ– -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-hierarchy@3/dist/d3-hierarchy.min.js"></script>

<!-- EChartsåº“ç”¨äºè‡ªå®šä¹‰æ¸²æŸ“ -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- é¡µé¢ç‰¹å®šçš„JavaScript -->
<script src="{{ url_for('static', filename='js/pack-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/image-detail.js') }}"></script>

<script>
// åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¯ Initializing simplified image detail page...');
    
         // åˆå§‹åŒ–å›¾ç‰‡è¯¦æƒ…é¡µé¢
     if (typeof ImageDetailPage !== 'undefined') {
         const container = document.querySelector('.detail-container');
         const imageId = container ? parseInt(container.getAttribute('data-image-id')) : null;
         if (imageId) {
             const detailPage = new ImageDetailPage(imageId);
             detailPage.initialize();
         }
     }
    
    // å¯è§†åŒ–æ§åˆ¶æŒ‰é’®äº‹ä»¶
    const vizControlButtons = document.querySelectorAll('.viz-control-btn');
    vizControlButtons.forEach(button => {
        button.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰activeç±»
            vizControlButtons.forEach(btn => btn.classList.remove('active'));
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            this.classList.add('active');
            
            const dimension = this.getAttribute('data-dimension');
            console.log(`ğŸ¯ Switching to ${dimension} dimension view`);
            
                         // å®ç°ç»´åº¦åˆ‡æ¢é€»è¾‘
             if (window.packChartInstance) {
                 window.packChartInstance.focusDimension(dimension);
             } else {
                 console.warn('Pack chart instance not available');
             }
        });
    });
});
</script>
{% endblock %}
