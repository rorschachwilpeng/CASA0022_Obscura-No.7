<!-- Obscura No.7 - Image Detail Page Template -->

{% extends "base.html" %}

{% block title %}Image Analysis - Obscura No.7{% endblock %}

{% block og_title %}Environmental Prediction Analysis - Obscura No.7{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/image-detail.css') }}">
{% endblock %}

{% block content %}
<div class="detail-page">
    <div class="detail-container" data-image-id="{% if image_id %}{{ image_id }}{% endif %}">
        <!-- ç®€åŒ–çš„é¡µé¢æ ‡é¢˜ -->
        <header class="detail-header">
            <h1 class="detail-title" id="imageTitle">Environmental Vision Analysis</h1>
            <p class="detail-subtitle" id="imageSubtitle">AI-Generated Environmental Art with SHAP Interpretability</p>
        </header>

        <!-- ç”µå½±é£æ ¼çš„å›¾ç‰‡å’Œæ•…äº‹æ¨¡å— -->
        <section class="cinema-section" aria-labelledby="cinema-section-title">
            <h2 id="cinema-section-title" class="sr-only">Environmental Vision Theater</h2>
            
            <div class="cinema-container">
                <!-- å›¾ç‰‡æ˜¾ç¤ºï¼ˆå·¦ä¾§ï¼Œç”µå½±å±å¹•é£æ ¼ï¼‰ -->
                <div class="cinema-screen">
                    <div class="screen-frame">
                        <img class="cinema-image" 
                             id="mainImage" 
                             alt=""
                             tabindex="0"
                             role="img">
                        
                        <!-- ä¸‹è½½æŒ‰é’®ï¼ˆå±å¹•ä¸‹æ–¹ï¼‰ -->
                        <div class="screen-controls">
                            <button class="download-button" 
                                    id="downloadBtn" 
                                    type="button"
                                    title="Download Image (Ctrl+D)">
                                <span aria-hidden="true">ğŸ’¾</span>
                                <span>Download Image</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- AIæ•…äº‹ï¼ˆå³ä¾§ï¼Œå‰§æœ¬é£æ ¼ï¼‰ -->
                <div class="cinema-story">
                    <div class="story-panel">
                        <div class="story-header">
                            <h3 class="story-title">
                                <span class="story-icon" aria-hidden="true">ğŸ“–</span>
                                Environmental Narrative
                            </h3>
                        </div>
                        
                        <div class="story-container">
                            <div class="story-loading" id="storyLoading">
                                <div class="story-spinner" aria-hidden="true">âœï¸</div>
                                <p>Generating environmental narrative...</p>
                            </div>
                            <div class="story-content" id="storyContent" style="display: none;">
                                <div class="narrative-text" id="narrativeText">
                                    Loading story...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¯å½¢æ‰“åŒ…å›¾å¯è§†åŒ–æ¨¡å— -->
        <section class="visualization-section" aria-labelledby="viz-section-title">
            <h2 id="viz-section-title" class="sr-only">Feature Impact Visualization</h2>
            
            <!-- SHAPä¸‰ç»´åº¦è¯„åˆ† -->
            <div class="shap-scores-overview" id="shapScoresOverview">
                <div class="score-card climate">
                    <div class="score-header">
                        <span class="score-icon" aria-hidden="true">ğŸŒ¡ï¸</span>
                        <h3>Climate</h3>
                    </div>
                    <div class="score-value" id="climateScore">Loading...</div>
                </div>
                
                <div class="score-card geographic">
                    <div class="score-header">
                        <span class="score-icon" aria-hidden="true">ğŸ—ºï¸</span>
                        <h3>Geographic</h3>
                    </div>
                    <div class="score-value" id="geographicScore">Loading...</div>
                </div>
                
                <div class="score-card economic">
                    <div class="score-header">
                        <span class="score-icon" aria-hidden="true">ğŸ’°</span>
                        <h3>Economic</h3>
                    </div>
                    <div class="score-value" id="economicScore">Loading...</div>
                </div>
            </div>
            
            <!-- åœ†å½¢æ‰“åŒ…å›¾å¯è§†åŒ–å®¹å™¨ -->
            <div class="pack-chart-container">
                <div class="chart-loading" id="packChartLoading">
                    <div class="chart-spinner" aria-hidden="true">âš™ï¸</div>
                    <p>Loading feature impact visualization...</p>
                </div>
                <div id="packChart" class="pack-chart" style="display: none;">
                    <!-- åœ†å½¢æ‰“åŒ…å›¾å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                </div>
            </div>
            
            <!-- å¯è§†åŒ–æ§åˆ¶ -->
            <div class="viz-controls" id="vizControls" style="display: none;">
                <button class="viz-control-btn active" data-dimension="overview">
                    <span aria-hidden="true">ğŸ¯</span>
                    Overview
                </button>
                <button class="viz-control-btn" data-dimension="climate">
                    <span aria-hidden="true">ğŸŒ¡ï¸</span>
                    Climate
                </button>
                <button class="viz-control-btn" data-dimension="geographic">
                    <span aria-hidden="true">ğŸ—ºï¸</span>
                    Geographic
                </button>
                <button class="viz-control-btn" data-dimension="economic">
                    <span aria-hidden="true">ğŸ’°</span>
                    Economic
                </button>
            </div>
        </section>
    </div>
</div>

<!-- Fullscreen Overlay -->
<div class="fullscreen-overlay" id="fullscreenOverlay" aria-hidden="true">
    <img class="fullscreen-image" 
         id="fullscreenImage" 
         alt=""
         role="img">
    <button class="fullscreen-close" 
            id="fullscreenClose" 
            type="button"
            aria-label="Exit fullscreen"
            title="Exit Fullscreen (ESC)">
        âœ•
    </button>
</div>

<!-- Loading Overlay for Initial Data -->
<div class="page-loading" id="pageLoading" aria-hidden="false">
    <div class="loading-content">
        <div class="brass-spinner">
            <div class="gear-spinner" aria-hidden="true">âš™ï¸</div>
        </div>
        <p>Processing through temporal mechanisms...</p>
    </div>
</div>

<!-- Screen Reader Announcements -->
<div class="sr-only" aria-live="polite" id="srAnnouncements"></div>

<!-- Hidden Elements for Screen Readers -->
<div class="sr-only">
    <h2>Page Navigation Help</h2>
    <p>This page displays detailed analysis of an AI-generated environmental prediction image. Use keyboard shortcuts: Ctrl+F for fullscreen, Ctrl+D to download, ESC to close overlays.</p>
</div>
{% endblock %}

{% block extra_js %}
<!-- D3.jsåº“ç”¨äºåœ†å½¢æ‰“åŒ…å›¾å¯è§†åŒ– -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-hierarchy@3/dist/d3-hierarchy.min.js"></script>

<!-- EChartsåº“ç”¨äºè‡ªå®šä¹‰æ¸²æŸ“ -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- é¡µé¢ç‰¹å®šçš„JavaScript -->
<script src="{{ url_for('static', filename='js/pack-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/image-detail.js') }}"></script>

<script>
// åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¬ Initializing cinema-style image detail page...');
    
    // åˆå§‹åŒ–å›¾ç‰‡è¯¦æƒ…é¡µé¢
    if (typeof ImageDetailPage !== 'undefined') {
        const container = document.querySelector('.detail-container');
        const imageId = container ? parseInt(container.getAttribute('data-image-id')) : null;
        if (imageId) {
            const detailPage = new ImageDetailPage(imageId);
            detailPage.initialize();
        }
    }
    
    // å¯è§†åŒ–æ§åˆ¶æŒ‰é’®äº‹ä»¶
    const vizControlButtons = document.querySelectorAll('.viz-control-btn');
    vizControlButtons.forEach(button => {
        button.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰activeç±»
            vizControlButtons.forEach(btn => btn.classList.remove('active'));
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            this.classList.add('active');
            
            const dimension = this.getAttribute('data-dimension');
            console.log(`ğŸ¯ Switching to ${dimension} dimension view`);
            
            // å®ç°ç»´åº¦åˆ‡æ¢é€»è¾‘
            if (window.packChartInstance) {
                window.packChartInstance.focusDimension(dimension);
            } else {
                console.warn('Pack chart instance not available');
            }
        });
    });
});
</script>
{% endblock %}
